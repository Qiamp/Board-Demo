<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMU & GNSS 数据可视化 (MQTT)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <!-- 添加图标字体 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- 添加苹果字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * { 
            box-sizing: border-box; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif; 
            margin: 0; 
            padding: 24px; 
            background: #f5f7fa;
            min-height: 100vh;
            color: #1d1d1f;
            font-weight: 400;
            letter-spacing: -0.011em;
            line-height: 1.47059;
        }
        
        .main-container {
            max-width: 2500px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.04);
        }
        
        .header {
            background: linear-gradient(135deg, #ffffff00 0%, #ffffff00 100%);
            color: white;
            padding: 32px 32px 40px;
            text-align: center;
        }
        
        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 24px;
            gap: 32px;
        }
        
        .logo-container img {
            height: 170px;
            width: auto;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 8px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 600;
            letter-spacing: -0.022em;
            line-height: 1.08349;
            color: #064f9e; /* 修改为您需要的颜色，例如蓝色 */
        }
        
        .content {
            padding: 32px;
        }
        
        /* MQTT 配置面板样式 - iOS风格 */
        .mqtt-config-panel { 
            background: #ffffff;
            border: 1px solid #e5e5e7;
            border-radius: 16px;
            margin-bottom: 32px;
            padding: 24px;
            transition: all 0.2s ease;
        }
        
        .mqtt-config-panel.hidden { 
            display: none; 
        }
        
        .config-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .config-header i {
            font-size: 1.3em;
            margin-right: 12px;
            color: #007aff;
        }
        
        .config-header h3 {
            margin: 0;
            color: #1d1d1f;
            font-size: 1.125em;
            font-weight: 600;
            letter-spacing: -0.022em;
        }
        
        .config-row { 
            display: flex; 
            align-items: center; 
            margin-bottom: 20px; 
            gap: 16px; 
        }
        
        .config-row label { 
            min-width: 110px; 
            font-weight: 500;
            color: #1d1d1f;
            font-size: 0.9em;
        }
        
        .config-row input { 
            flex: 1; 
            padding: 12px 16px; 
            border: 1px solid #d2d2d7; 
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.2s ease;
            background: #ffffff;
            font-family: inherit;
        }
        
        .config-row input:focus {
            outline: none;
            border-color: #007aff;
            background: #ffffff;
        }
        
        .button-container {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
            letter-spacing: -0.011em;
            min-height: 44px;
        }
        
        .btn:hover {
            transform: scale(0.98);
        }
        
        .btn:active {
            transform: scale(0.96);
        }
        
        .btn-primary {
            background: #007aff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056cc;
        }
        
        .btn-danger {
            background: #ff3b30;
            color: white;
        }
        
        .btn-danger:hover {
            background: #d70015;
        }
        
        .btn-secondary {
            background: #8e8e93;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #636366;
        }
        
        .btn-info {
            background: #5ac8fa;
            color: white;
        }
        
        .btn-info:hover {
            background: #007aff;
        }
        
        /* 状态面板 - iOS卡片风格 */
        .status-panels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .status-panel, .debug-panel { 
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e5e5e7;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            padding: 0;
        }
        
        .status-item i {
            width: 20px;
            margin-right: 12px;
            color: #8e8e93;
            font-size: 0.9em;
        }
        
        .status-label {
            font-weight: 500;
            margin-right: 12px;
            color: #1d1d1f;
            font-size: 0.9em;
        }
        
        .status-value {
            color: #3a3a3c;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            font-size: 0.85em;
        }
        
        .connection-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-connected { background: #d1f2eb; color: #00c896; }
        .status-connecting { background: #fff3cd; color: #f1c40f; }
        .status-disconnected { background: #f8d7da; color: #dc3545; }
        .status-error { background: #f5c6cb; color: #721c24; }
        
        /* 图表容器 - iOS风格 */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .chart-container { 
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e5e5e7;
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f2f2f7;
        }
        
        .chart-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
            font-weight: 600;
            color: #1d1d1f;
            letter-spacing: -0.022em;
        }
        
        .chart-title i {
            color: #007aff;
            font-size: 0.9em;
        }
        
        .chart-canvas {
            height: 300px;
        }
        
        /* 地图容器 */
        .map-section {
            margin-top: 32px;
        }
        
        .map-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 12px;
        }
        
        .map-header i {
            color: #34c759;
            font-size: 1.3em;
        }
        
        .map-header h3 {
            margin: 0;
            color: #1d1d1f;
            font-weight: 600;
            font-size: 1.25em;
            letter-spacing: -0.022em;
        }
        
        #map-container { 
            width: 100%; 
            height: 400px; /* 减小地图高度 */
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #e5e5e7;
        }
        
        /* 工具提示 - iOS风格 */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px);
            color: #fff;
            text-align: center;
            border-radius: 12px;
            padding: 12px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 13px;
            font-weight: 500;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* 加载动画 - iOS风格 */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007aff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 主要内容网格布局 - 调整地图和图表比例 */
        .main-content-grid {
            display: grid;
            grid-template-columns: 1.2fr 1.8fr; /* 地图1份，图表2份 */
            gap: 32px;
            margin-bottom: 32px;
        }
        
        .charts-section {
            display: flex;
            flex-direction: column;
        }
        
        /* 图表网格 - 调整为2x2布局 */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 100%;
        }
        
        .chart-container { 
            background: #ffffff;
            max-width: 100%; /* 确保容器宽度可以自适应 */
            height: 300px;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #e5e5e7;
            display: flex;
            flex-direction: column;
        }
        
        .chart-canvas {
            width: 700px;
            height: auto;
            flex: 1;
        }
        
        /* 地图部分样式调整 */
        .map-section {
            display: flex;
            flex-direction: column;
        }
        
        #map-container { 
            width: 100%; 
            height: 600px; /* 减小地图高度 */
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #e5e5e7;
            flex: 1;
        }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .main-content-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            #map-container {
                height: 500px; /* 响应式时进一步减小地图高度 */
            }
        }
        
        @media (max-width: 768px) {
            body { padding: 16px; }
            
            .content { padding: 24px; }
            
            .logo-container {
                flex-direction: column;
                gap: 16px;
            }
            
            .logo-container img {
                height: 60px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .config-row {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .config-row label {
                min-width: auto;
            }
            
            .button-container {
                flex-direction: column;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                min-width: auto;
            }
            
            .status-panels {
                grid-template-columns: 1fr;
            }
            
            .main-content-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                min-width: auto;
            }
            
            #map-container {
                height: 300px; /* 移动端进一步减小地图高度 */
            }
        }
        
        /* 暗色主题适配 */
        @media (prefers-color-scheme: dark) {
            body {
                background: #000000;
                color: #f2f2f7;
            }
            
            .main-container {
                background: #1c1c1e;
                border: 1px solid #38383a;
            }
            
            .chart-container, .status-panel, .debug-panel, .mqtt-config-panel {
                background: #1c1c1e;
                border: 1px solid #38383a;
                color: #f2f2f7;
            }
            
            .config-row input {
                background: #2c2c2e;
                border: 1px solid #48484a;
                color: #f2f2f7;
            }
            
            .config-row input:focus {
                border-color: #0a84ff;
            }
            
            .status-label {
                color: #f2f2f7;
            }
            
            .status-value {
                color: #aeaeb2;
            }
            
            .chart-title {
                color: #f2f2f7;
            }
            
            .map-header h3 {
                color: #f2f2f7;
            }
            
            .config-header h3 {
                color: #f2f2f7;
            }
        }
        
        /* 自定义滚动条 - iOS风格 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.3);
        }
        
        /* 输入框聚焦动画 */
        .config-row input {
            transform: scale(1);
        }
        
        .config-row input:focus {
            transform: scale(1.02);
        }
        
        /* 按钮点击反馈 */
        .btn {
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <div class="logo-container">
                <img src="./polyu.png" alt="PolyU Logo" title="香港理工大学">
                <img src="./taslab.png" alt="TAS Lab Logo" title="TAS 实验室">
            </div>
            <h1><i class="fas fa-satellite"></i> 惯性单元 & 定位导航系统 实时数据可视化</h1>
        </div>
        
        <div class="content">
            <!-- MQTT 配置面板 -->
            <div id="mqttConfigPanel" class="mqtt-config-panel">
                <div class="config-header">
                    <i class="fas fa-network-wired"></i>
                    <h3>MQTT 连接配置</h3>
                </div>
                
                <div class="config-row">
                    <label><i class="fas fa-user"></i> 客户端 ID:</label>
                    <input type="text" id="clientId" placeholder="输入您的客户端ID" value="web_client_123">
                </div>
                
                <div class="config-row">
                    <label><i class="fas fa-id-badge"></i> 用户名:</label>
                    <input type="text" id="username" placeholder="输入MQTT用户名">
                </div>
                
                <div class="config-row">
                    <label><i class="fas fa-lock"></i> 密码:</label>
                    <input type="password" id="password" placeholder="输入MQTT密码">
                </div>
                
                <div class="button-container">
                    <button class="btn btn-primary" onclick="connectMQTT()">
                        <i class="fas fa-plug"></i> 连接 MQTT
                    </button>
                    <button class="btn btn-danger" onclick="disconnectMQTT()">
                        <i class="fas fa-unlink"></i> 断开连接
                    </button>
                </div>
            </div>
            
            <!-- 状态面板 -->
            <div class="status-panels">
                <div class="status-panel">
                    <div class="status-item">
                        <i class="fas fa-wifi"></i>
                        <span class="status-label">MQTT 状态:</span>
                        <span id="mqttStatus" class="connection-status status-disconnected">未连接</span>
                    </div>
                    
                    <div class="status-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span class="status-label">GNSS 位置:</span>
                        <span id="positionStatus" class="status-value">等待数据...</span>
                    </div>
                    
                    <div class="status-item">
                        <i class="fas fa-microchip"></i>
                        <span class="status-label">惯性单元1 数据点:</span>
                        <span id="imu0Count" class="status-value">0</span>
                    </div>
                    
                    <div class="status-item">
                        <i class="fas fa-microchip"></i>
                        <span class="status-label">惯性单元2 数据点:</span>
                        <span id="imu1Count" class="status-value">0</span>
                    </div>
                    
                    <div class="button-container" style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="clearData()">
                            <i class="fas fa-trash"></i> 清空数据
                        </button>
                        <button class="btn btn-info" onclick="showConfig()">
                            <i class="fas fa-cog"></i> 显示配置
                        </button>
                        <button class="btn btn-warning btn-smoothing" onclick="toggleSmoothing()">
                            <i class="fas fa-wave-square"></i> 禁用平滑
                        </button>
                    </div>
                </div>
                
                <div class="debug-panel">
                    <div class="status-item">
                        <i class="fas fa-envelope"></i>
                        <span class="status-label">最后消息:</span>
                        <span id="lastMessage" class="status-value">无</span>
                    </div>
                    
                    <div class="status-item">
                        <i class="fas fa-counter"></i>
                        <span class="status-label">消息计数:</span>
                        <span id="messageCount" class="status-value">0</span>
                    </div>
                    
                    <div class="status-item">
                        <i class="fas fa-tachometer-alt"></i>
                        <span class="status-label">更新频率:</span>
                        <span id="updateFreq" class="status-value">0</span> 次/秒
                    </div>
                </div>
            </div>
            
            <!-- 主要内容区域：地图和图表并排 -->
            <div class="main-content-grid">
                <!-- 地图部分 -->
                <div class="map-section">
                    <div class="map-header">
                        <i class="fas fa-globe"></i>
                        <h3>GNSS 实时位置</h3>
                    </div>
                    <div id="map-container"></div>
                </div>
                
                <!-- 图表部分 -->
                <div class="charts-section">
                    <h3> </h3> <!-- 添加一行，用于地图和图表并排 -->
                    <div class="map-header">
                        <i class="fas fa-microchip"></i>
                        <h3>惯性单元 实时信息</h3>
                    </div>
                    
                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-header">
                                <div class="chart-title">
                                    <i class="fas fa-sync-alt"></i>
                                    <span>惯性单元1  角速度 (°/s)</span>
                                </div>
                                <div class="tooltip">
                                    <i class="fas fa-info-circle" style="color: #7f8c8d;"></i>
                                    <span class="tooltiptext">显示惯性单元1传感器的三轴角速度数据</span>
                                </div>
                            </div>
                            <div class="chart-canvas">
                                <canvas id="imu0AngularVelocityChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-header">
                                <div class="chart-title">
                                    <i class="fas fa-arrows-alt"></i>
                                    <span>惯性单元1  线加速度 (m/s²)</span>
                                </div>
                                <div class="tooltip">
                                    <i class="fas fa-info-circle" style="color: #7f8c8d;"></i>
                                    <span class="tooltiptext">显示惯性单元1传感器的三轴线性加速度数据</span>
                                </div>
                            </div>
                            <div class="chart-canvas">
                                <canvas id="imu0LinearAccelerationChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-header">
                                <div class="chart-title">
                                    <i class="fas fa-sync-alt"></i>
                                    <span>惯性单元2  角速度 (°/s)</span>
                                </div>
                                <div class="tooltip">
                                    <i class="fas fa-info-circle" style="color: #7f8c8d;"></i>
                                    <span class="tooltiptext">显示惯性单元2传感器的三轴角速度数据</span>
                                </div>
                            </div>
                            <div class="chart-canvas">
                                <canvas id="imu1AngularVelocityChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-header">
                                <div class="chart-title">
                                    <i class="fas fa-arrows-alt"></i>
                                    <span>惯性单元2  线加速度 (m/s²)</span>
                                </div>
                                <div class="tooltip">
                                    <i class="fas fa-info-circle" style="color: #7f8c8d;"></i>
                                    <span class="tooltiptext">显示惯性单元2传感器的三轴线性加速度数据</span>
                                </div>
                            </div>
                            <div class="chart-canvas">
                                <canvas id="imu1LinearAccelerationChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // MQTT 配置（固定部分）
        const MQTT_CONFIG = {
            broker: 'wss://broker.emqx.io:8084/mqtt',
            topic: 'test/combined',
            qos: 0,
            clean: false,
            keepalive: 60,
            reconnectPeriod: 1000
        };
        
        // 全局变量
        const MAX_POINTS = 50;
        let messageCounter = 0;
        let mqttClient = null;
        let lastUpdateTime = Date.now();
        let messageQueue = [];
        let updatePending = false;
        let dataWorker = null; // Web Worker 实例
        let updateTimer = null; // 定时更新计时器
        let chartUpdateThrottle = 100; // 图表更新频率限制 (ms)
        
        // 数据平滑配置
        let smoothingEnabled = true;
        const SMOOTHING_WINDOW = 5; // 移动平均窗口大小
        
        // 数据存储（原始数据和平滑后数据）
        let imuData = {
            imu0: { 
                av: { x: [], y: [], z: [] }, 
                la: { x: [], y: [], z: [] },
                smoothed: {
                    av: { x: [], y: [], z: [] },
                    la: { x: [], y: [], z: [] }
                }
            },
            imu1: { 
                av: { x: [], y: [], z: [] }, 
                la: { x: [], y: [], z: [] },
                smoothed: {
                    av: { x: [], y: [], z: [] },
                    la: { x: [], y: [], z: [] }
                }
            }
        };
        
        // 图表实例
        const charts = {
            imu0Av: null,
            imu0La: null,
            imu1Av: null,
            imu1La: null
        };
        
        // 地图实例
        let map = null;
        let marker = null;
        let polyline = null;
        
        // 初始化 Web Worker
        function initWorker() {
            if (window.Worker) {
                // 创建 Blob URL
                const workerCode = `
                    // 解析综合数据消息
                    // 格式: "imu0,sec,nsec,ox,oy,oz,avx,avy,avz,lax,lay,laz;imu1,sec,nsec,ox,oy,oz,avx,avy,avz,lax,lay,laz;gnss,lat,lng,alt"
                    function parseCombinedMessage(message) {
                        try {
                            const parts = message.split(';');
                            const result = {};
                            
                            parts.forEach(part => {
                                const data = part.split(',');
                                const type = data[0];
                                
                                switch(type) {
                                    case 'imu0':
                                    case 'imu1':
                                        if (data.length >= 12) {
                                            result[type] = {
                                                type: type,
                                                timestamp: {
                                                    sec: parseFloat(data[1]),
                                                    nsec: parseFloat(data[2])
                                                },
                                                orientation: {
                                                    x: parseFloat(data[3]),
                                                    y: parseFloat(data[4]),
                                                    z: parseFloat(data[5])
                                                },
                                                angular_velocity: {
                                                    x: parseFloat(data[6]),
                                                    y: parseFloat(data[7]),
                                                    z: parseFloat(data[8])
                                                },
                                                linear_acceleration: {
                                                    x: parseFloat(data[9]),
                                                    y: parseFloat(data[10]),
                                                    z: parseFloat(data[11])
                                                }
                                            };
                                        }
                                        break;
                                    case 'gnss':
                                        if (data.length >= 4) {
                                            result.gnss = {
                                                type: 'gnss',
                                                latitude: parseFloat(data[1]),
                                                longitude: parseFloat(data[2]),
                                                altitude: parseFloat(data[3])
                                            };
                                        }
                                        break;
                                }
                            });
                            
                            return result;
                        } catch (e) {
                            console.error('解析消息时出错:', e);
                            return null;
                        }
                    }

                    // 应用平滑处理
                    function applyMovingAverage(data, windowSize = 5) {
                        if (data.length < windowSize) return data;
                        
                        const smoothed = [];
                        for (let i = 0; i < data.length; i++) {
                            let sum = 0;
                            let count = 0;
                            
                            // 计算窗口范围
                            const start = Math.max(0, i - Math.floor(windowSize / 2));
                            const end = Math.min(data.length - 1, i + Math.floor(windowSize / 2));
                            
                            for (let j = start; j <= end; j++) {
                                sum += data[j];
                                count++;
                            }
                            
                            smoothed.push(sum / count);
                        }
                        
                        return smoothed;
                    }
                    
                    // 处理一批消息
                    function processBatch(messages, maxPoints) {
                        // 创建新数据结构
                        const result = {
                            imu0: { av: {x: [], y: [], z: []}, la: {x: [], y: [], z: []} },
                            imu1: { av: {x: [], y: [], z: []}, la: {x: [], y: [], z: []} },
                            gnss: []
                        };
                        
                        // 处理每条消息
                        messages.forEach(message => {
                            const parsed = parseCombinedMessage(message);
                            if (!parsed) return;
                            
                            // 收集IMU0数据
                            if (parsed.imu0) {
                                result.imu0.av.x.push(parsed.imu0.angular_velocity.x);
                                result.imu0.av.y.push(parsed.imu0.angular_velocity.y);
                                result.imu0.av.z.push(parsed.imu0.angular_velocity.z);
                                
                                result.imu0.la.x.push(parsed.imu0.linear_acceleration.x);
                                result.imu0.la.y.push(parsed.imu0.linear_acceleration.y);
                                result.imu0.la.z.push(parsed.imu0.linear_acceleration.z);
                            }
                            
                            // 收集IMU1数据
                            if (parsed.imu1) {
                                result.imu1.av.x.push(parsed.imu1.angular_velocity.x);
                                result.imu1.av.y.push(parsed.imu1.angular_velocity.y);
                                result.imu1.av.z.push(parsed.imu1.angular_velocity.z);
                                
                                result.imu1.la.x.push(parsed.imu1.linear_acceleration.x);
                                result.imu1.la.y.push(parsed.imu1.linear_acceleration.y);
                                result.imu1.la.z.push(parsed.imu1.linear_acceleration.z);
                            }
                            
                            // 收集GNSS数据
                            if (parsed.gnss) {
                                result.gnss.push({
                                    latitude: parsed.gnss.latitude,
                                    longitude: parsed.gnss.longitude,
                                    altitude: parsed.gnss.altitude
                                });
                            }
                        });
                        
                        // 向主线程返回处理后的数据
                        self.postMessage({
                            type: 'processedData',
                            data: result
                        });
                    }
                    
                    // 监听来自主线程的消息
                    self.onmessage = function(e) {
                        const { type, data } = e.data;
                        
                        switch(type) {
                            case 'processBatch':
                                processBatch(data.messages, data.maxPoints);
                                break;
                            default:
                                console.log('Worker收到未知类型消息:', type);
                        }
                    };
                `;
                
                const blob = new Blob([workerCode], { type: 'application/javascript' });
                const workerUrl = URL.createObjectURL(blob);
                
                dataWorker = new Worker(workerUrl);
                
                // 设置worker消息处理
                dataWorker.onmessage = function(e) {
                    const { type, data } = e.data;
                    
                    if (type === 'processedData') {
                        // 更新数据存储
                        updateDataFromWorker(data);
                        // 触发图表更新
                        scheduleChartUpdate();
                    }
                };
                
                console.log('Web Worker 初始化成功');
            } else {
                console.error('浏览器不支持 Web Worker');
                // 降级处理: 使用主线程处理
            }
        }
        
        // MQTT 连接函数
        function connectMQTT() {
            const clientId = document.getElementById('clientId').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!clientId || !username || !password) {
                showNotification('请填写完整的MQTT连接信息!', 'warning');
                return;
            }
            
            // 更新状态
            updateConnectionStatus('connecting');
            
            const options = {
                clientId: clientId,
                username: username,
                password: password,
                clean: MQTT_CONFIG.clean,
                keepalive: MQTT_CONFIG.keepalive,
                reconnectPeriod: MQTT_CONFIG.reconnectPeriod
            };
            
            try {
                mqttClient = mqtt.connect(MQTT_CONFIG.broker, options);
                
                mqttClient.on('connect', () => {
                    console.log('MQTT 连接成功');
                    updateConnectionStatus('connected');
                    showNotification('MQTT 连接成功!', 'success');
                    
                    mqttClient.subscribe(MQTT_CONFIG.topic, { qos: MQTT_CONFIG.qos }, (err) => {
                        if (err) {
                            console.error('订阅失败:', err);
                            showNotification('订阅主题失败', 'error');
                        } else {
                            console.log('订阅成功:', MQTT_CONFIG.topic);
                            showNotification('订阅主题成功', 'success');
                        }
                    });
                    
                    document.getElementById('mqttConfigPanel').classList.add('hidden');
                });
                
                mqttClient.on('message', (topic, message) => {
                    handleMQTTMessage(message.toString());
                });
                
                mqttClient.on('error', (error) => {
                    console.error('MQTT 错误:', error);
                    updateConnectionStatus('error');
                    showNotification('MQTT 连接错误: ' + error.message, 'error');
                });
                
                mqttClient.on('close', () => {
                    updateConnectionStatus('disconnected');
                });
                
                mqttClient.on('reconnect', () => {
                    updateConnectionStatus('connecting');
                });
                
            } catch (error) {
                console.error('MQTT 连接失败:', error);
                updateConnectionStatus('error');
                showNotification('MQTT 连接失败: ' + error.message, 'error');
            }
        }
        
        // 更新连接状态显示
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('mqttStatus');
            statusElement.className = 'connection-status';
            
            switch(status) {
                case 'connected':
                    statusElement.classList.add('status-connected');
                    statusElement.innerHTML = '<i class="fas fa-check-circle"></i> 已连接';
                    break;
                case 'connecting':
                    statusElement.classList.add('status-connecting');
                    statusElement.innerHTML = '<i class="loading"></i> 连接中';
                    break;
                case 'disconnected':
                    statusElement.classList.add('status-disconnected');
                    statusElement.innerHTML = '<i class="fas fa-times-circle"></i> 连接断开';
                    break;
                case 'error':
                    statusElement.classList.add('status-error');
                    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 连接错误';
                    break;
            }
        }
        
        // 通知系统
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 24px;
                right: 24px;
                padding: 16px 20px;
                border-radius: 16px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                max-width: 320px;
                backdrop-filter: blur(20px);
                font-family: inherit;
                font-size: 15px;
                letter-spacing: -0.011em;
            `;
            
            const colors = {
                success: 'rgba(52, 199, 89, 0.9)',
                error: 'rgba(255, 59, 48, 0.9)',
                warning: 'rgba(255, 204, 0, 0.9)',
                info: 'rgba(0, 122, 255, 0.9)'
            };
            
            notification.style.background = colors[type] || colors.info;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation' : 'info'}-circle" style="margin-right: 8px;"></i>${message}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s cubic-bezier(0.55, 0.06, 0.68, 0.19)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // 添加iOS风格动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { 
                    transform: translateX(100%) scale(0.9); 
                    opacity: 0; 
                }
                to { 
                    transform: translateX(0) scale(1); 
                    opacity: 1; 
                }
            }
            @keyframes slideOut {
                from { 
                    transform: translateX(0) scale(1); 
                    opacity: 1; 
                }
                to { 
                    transform: translateX(100%) scale(0.9); 
                    opacity: 0; 
                }
            }
        `;
        document.head.appendChild(style);
        
        // MQTT 断开连接
        function disconnectMQTT() {
            if (mqttClient) {
                mqttClient.end();
                mqttClient = null;
                showNotification('MQTT 连接已断开', 'info');
            }
            updateConnectionStatus('disconnected');
            document.getElementById('mqttConfigPanel').classList.remove('hidden');
        }
        
        // 显示配置面板
        function showConfig() {
            document.getElementById('mqttConfigPanel').classList.remove('hidden');
        }
        
        // 处理 MQTT 消息 - 新版实现
        function handleMQTTMessage(message) {
            messageCounter++;
            document.getElementById('messageCount').textContent = messageCounter;
            
            // 只更新最后接收的消息文本，降低DOM操作频率
            if (messageCounter % 10 === 0) {
                document.getElementById('lastMessage').textContent = message.substring(0, 50) + '...';
            }
            
            // 将消息加入队列
            messageQueue.push(message);
            
            // 队列长度达到阈值或达到时间间隔时处理队列
            if (messageQueue.length >= 20) { // 批处理阈值
                processBatchInWorker();
            }
        }
        
        // 使用Web Worker批量处理消息
        function processBatchInWorker() {
            if (!dataWorker || messageQueue.length === 0) return;
            
            // 获取需要处理的消息
            const messagesToProcess = messageQueue.splice(0, messageQueue.length);
            
            // 发送到Worker处理
            dataWorker.postMessage({
                type: 'processBatch',
                data: {
                    messages: messagesToProcess,
                    maxPoints: MAX_POINTS
                }
            });
        }
        
        // 从Worker更新数据
        function updateDataFromWorker(workerData) {
            // 更新IMU0数据
            if (workerData.imu0) {
                const imu0 = workerData.imu0;
                
                // 更新角速度数据
                appendDataWithLimit(imuData.imu0.av.x, imu0.av.x);
                appendDataWithLimit(imuData.imu0.av.y, imu0.av.y);
                appendDataWithLimit(imuData.imu0.av.z, imu0.av.z);
                
                // 更新线加速度数据
                appendDataWithLimit(imuData.imu0.la.x, imu0.la.x);
                appendDataWithLimit(imuData.imu0.la.y, imu0.la.y);
                appendDataWithLimit(imuData.imu0.la.z, imu0.la.z);
            }
            
            // 更新IMU1数据
            if (workerData.imu1) {
                const imu1 = workerData.imu1;
                
                // 更新角速度数据
                appendDataWithLimit(imuData.imu1.av.x, imu1.av.x);
                appendDataWithLimit(imuData.imu1.av.y, imu1.av.y);
                appendDataWithLimit(imuData.imu1.av.z, imu1.av.z);
                
                // 更新线加速度数据
                appendDataWithLimit(imuData.imu1.la.x, imu1.la.x);
                appendDataWithLimit(imuData.imu1.la.y, imu1.la.y);
                appendDataWithLimit(imuData.imu1.la.z, imu1.la.z);
            }
            
            // 应用平滑处理
            if (smoothingEnabled) {
                smoothSensorData('imu0');
                smoothSensorData('imu1');
            }
            
            // 更新GNSS数据
            if (workerData.gnss && workerData.gnss.length > 0) {
                const latestPosition = workerData.gnss[workerData.gnss.length - 1];
                updateMapPosition(latestPosition.longitude, latestPosition.latitude);
            }
            
            // 更新数据点计数
            document.getElementById('imu0Count').textContent = imuData.imu0.av.x.length;
            document.getElementById('imu1Count').textContent = imuData.imu1.av.x.length;
        }
        
        // 添加数据并保持长度限制
        function appendDataWithLimit(array, newData) {
            if (!newData || newData.length === 0) return;
            
            array.push(...newData);
            if (array.length > MAX_POINTS) {
                array.splice(0, array.length - MAX_POINTS);
            }
        }
        
        // 初始化图表
        function initCharts() {
            const createChart = (elementId, title, labels, yAxisConfig = {}) => {
                const defaultYAxisConfig = {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: title
                    },
                    ticks: {
                        maxTicksLimit: 6
                    }
                };
                
                // 合并自定义配置和默认配置
                const yAxis = { ...defaultYAxisConfig, ...yAxisConfig };
                
                return new Chart(document.getElementById(elementId), {
                    type: 'line',
                    data: {
                        datasets: [
                            { 
                                label: labels[0], 
                                borderColor: 'rgb(255, 99, 132)', 
                                data: [],
                                pointRadius: 0,
                                borderWidth: 1.5
                            },
                            { 
                                label: labels[1], 
                                borderColor: 'rgb(54, 162, 235)', 
                                data: [],
                                pointRadius: 0,
                                borderWidth: 1.5
                            },
                            { 
                                label: labels[2], 
                                borderColor: 'rgb(75, 192, 192)', 
                                data: [],
                                pointRadius: 0,
                                borderWidth: 1.5
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        devicePixelRatio: 1,
                        scales: { 
                            x: {
                                type: 'linear',
                                position: 'bottom',
                                title: {
                                    display: true,
                                    text: '样本点'
                                },
                                ticks: {
                                    maxTicksLimit: 10
                                }
                            },
                            y: yAxis
                        },
                        animation: false,
                        elements: {
                            line: {
                                tension: 0
                            }
                        },
                        plugins: { 
                            legend: {
                                position: 'top',
                                labels: {
                                    boxWidth: 12,
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            };
            
            // 为角速度图表设置 y 轴范围为 -200 到 200
            const angularVelocityYAxis = {
                beginAtZero: false,
                min: -200,
                max: 200,
                title: {
                    display: true,
                    text: 'IMU0 角速度'
                },
                ticks: {
                    maxTicksLimit: 6
                }
            };
            
            // 为角速度图表设置 y 轴范围为 -200 到 200
            const angularVelocityYAxis1 = {
                beginAtZero: false,
                min: -200,
                max: 200,
                title: {
                    display: true,
                    text: 'IMU1 角速度'
                },
                ticks: {
                    maxTicksLimit: 6
                }
            };
            
            charts.imu0Av = createChart(
                'imu0AngularVelocityChart', 
                'IMU0 角速度', 
                ['X 轴', 'Y 轴', 'Z 轴'],
                angularVelocityYAxis
            );
            
            charts.imu0La = createChart(
                'imu0LinearAccelerationChart', 
                'IMU0 线加速度', 
                ['X 轴', 'Y 轴', 'Z 轴']
            );
            
            charts.imu1Av = createChart(
                'imu1AngularVelocityChart', 
                'IMU1 角速度', 
                ['X 轴', 'Y 轴', 'Z 轴'],
                angularVelocityYAxis1
            );
            
            charts.imu1La = createChart(
                'imu1LinearAccelerationChart', 
                'IMU1 线加速度', 
                ['X 轴', 'Y 轴', 'Z 轴']
            );
        }
        
        // 初始化地图
        function initMap() {
            try {
                // 初始化 Leaflet 地图
                map = L.map('map-container').setView([22.30184, 114.184478], 15);

                // 添加 OpenStreetMap 图层
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);

                // 添加标记
                marker = L.marker([22.30184, 114.184478]).addTo(map);

                // 添加轨迹图层
                polyline = L.polyline([], { color: 'blue' }).addTo(map);
                
                console.log('地图初始化成功');
            } catch (e) {
                console.error("地图初始化失败:", e);
                document.getElementById('map-container').innerHTML =
                    '<div style="padding:20px;text-align:center;">地图加载失败,请检查网络连接</div>';
            }
        }
        
        // 更新地图位置
        function updateMapPosition(lng, lat) {
            if (!map || !marker || !polyline) return;

            try {
                const position = [lat, lng];
                marker.setLatLng(position);
                polyline.addLatLng(position); // 添加轨迹点
                
                // 只在必要时重新定位地图视图
                const bounds = polyline.getBounds();
                if (!map.getBounds().contains(position)) {
                    map.setView(position, map.getZoom());
                }
                
                document.getElementById('positionStatus').textContent = 
                    `经度: ${lng.toFixed(6)}, 纬度: ${lat.toFixed(6)}`;
            } catch (e) {
                console.error("更新地图位置失败:", e);
            }
        }
        
        // 平滑处理单个传感器的所有数据
        function smoothSensorData(sensor) {
            const sensorData = imuData[sensor];
            
            // 平滑角速度数据
            sensorData.smoothed.av.x = applyMovingAverage(sensorData.av.x);
            sensorData.smoothed.av.y = applyMovingAverage(sensorData.av.y);
            sensorData.smoothed.av.z = applyMovingAverage(sensorData.av.z);
            
            // 平滑线加速度数据
            sensorData.smoothed.la.x = applyMovingAverage(sensorData.la.x);
            sensorData.smoothed.la.y = applyMovingAverage(sensorData.la.y);
            sensorData.smoothed.la.z = applyMovingAverage(sensorData.la.z);
        }
        
        // 添加平滑处理函数
        function applyMovingAverage(data, windowSize = SMOOTHING_WINDOW) {
            if (data.length < windowSize) return data;
            
            const smoothed = [];
            for (let i = 0; i < data.length; i++) {
                let sum = 0;
                let count = 0;
                
                // 计算窗口范围
                const start = Math.max(0, i - Math.floor(windowSize / 2));
                const end = Math.min(data.length - 1, i + Math.floor(windowSize / 2));
                
                for (let j = start; j <= end; j++) {
                    sum += data[j];
                    count++;
                }
                
                smoothed.push(sum / count);
            }
            
            return smoothed;
        }
        
        // 切换平滑处理
        function toggleSmoothing() {
            smoothingEnabled = !smoothingEnabled;
            
            // 更新按钮状态
            const button = document.querySelector('.btn-smoothing');
            if (smoothingEnabled) {
                button.innerHTML = '<i class="fas fa-wave-square"></i> 禁用平滑';
                button.className = 'btn btn-warning btn-smoothing';
            } else {
                button.innerHTML = '<i class="fas fa-chart-line"></i> 启用平滑';
                button.className = 'btn btn-success btn-smoothing';
            }
            
            // 重新处理所有数据
            smoothSensorData('imu0');
            smoothSensorData('imu1');
            
            // 立即更新图表
            updateAllCharts();
            
            showNotification(
                smoothingEnabled ? '数据平滑已启用' : '数据平滑已禁用', 
                'info'
            );
        }
        
        // 安排图表更新 - 使用节流控制更新频率
        function scheduleChartUpdate() {
            if (updateTimer) return; // 已经有待执行的更新
            
            updateTimer = setTimeout(() => {
                updateTimer = null;
                updateAllCharts();
                
                // 如果队列中还有消息，继续处理
                if (messageQueue.length > 0) {
                    processBatchInWorker();
                }
            }, chartUpdateThrottle);
        }

        // 使用批处理更新图表数据
        function updateChart(chart, xData, yData, zData) {
            // 根据平滑设置选择数据源
            const dataToUse = smoothingEnabled ? 
                { x: xData.smoothed || xData.raw, 
                  y: yData.smoothed || yData.raw, 
                  z: zData.smoothed || zData.raw } :
                { x: xData.raw || xData, 
                  y: yData.raw || yData, 
                  z: zData.raw || zData };
            
            // 直接更新数据集而不是重新创建
            chart.data.datasets[0].data = dataToUse.x.map((v, i) => ({x: i, y: v}));
            chart.data.datasets[1].data = dataToUse.y.map((v, i) => ({x: i, y: v}));
            chart.data.datasets[2].data = dataToUse.z.map((v, i) => ({x: i, y: v}));
            
            // 使用none模式避免不必要的动画
            chart.update('none');
        }

        // 使用请求动画帧更新图表，避免阻塞UI
        function updateAllCharts() {
            if (updatePending) return;
            
            updatePending = true;
            requestAnimationFrame(() => {
                if (!charts.imu0Av || !charts.imu0La || !charts.imu1Av || !charts.imu1La) {
                    updatePending = false;
                    return;
                }
                
                const now = Date.now();
                const elapsed = now - lastUpdateTime;
                if (elapsed > 0) {
                    const frequency = Math.round((1000 / elapsed) * 10) / 10;
                    document.getElementById('updateFreq').textContent = frequency;
                }
                lastUpdateTime = now;
                
                // 获取要显示的数据（原始或平滑）
                const getData = (sensor, type) => {
                    if (smoothingEnabled) {
                        return imuData[sensor].smoothed[type];
                    } else {
                        return imuData[sensor][type];
                    }
                };
                
                updateChart(charts.imu0Av, 
                    { raw: imuData.imu0.av.x, smoothed: imuData.imu0.smoothed.av.x },
                    { raw: imuData.imu0.av.y, smoothed: imuData.imu0.smoothed.av.y },
                    { raw: imuData.imu0.av.z, smoothed: imuData.imu0.smoothed.av.z }
                );
                
                updateChart(charts.imu0La, 
                    { raw: imuData.imu0.la.x, smoothed: imuData.imu0.smoothed.la.x },
                    { raw: imuData.imu0.la.y, smoothed: imuData.imu0.smoothed.la.y },
                    { raw: imuData.imu0.la.z, smoothed: imuData.imu0.smoothed.la.z }
                );
                
                updateChart(charts.imu1Av, 
                    { raw: imuData.imu1.av.x, smoothed: imuData.imu1.smoothed.av.x },
                    { raw: imuData.imu1.av.y, smoothed: imuData.imu1.smoothed.av.y },
                    { raw: imuData.imu1.av.z, smoothed: imuData.imu1.smoothed.av.z }
                );
                
                updateChart(charts.imu1La, 
                    { raw: imuData.imu1.la.x, smoothed: imuData.imu1.smoothed.la.x },
                    { raw: imuData.imu1.la.y, smoothed: imuData.imu1.smoothed.la.y },
                    { raw: imuData.imu1.la.z, smoothed: imuData.imu1.smoothed.la.z }
                );
                
                updatePending = false;
            });
        }
        
        // 清空数据
        function clearData() {
            imuData = {
                imu0: { 
                    av: { x: [], y: [], z: [] }, 
                    la: { x: [], y: [], z: [] },
                    smoothed: {
                        av: { x: [], y: [], z: [] },
                        la: { x: [], y: [], z: [] }
                    }
                },
                imu1: { 
                    av: { x: [], y: [], z: [] }, 
                    la: { x: [], y: [], z: [] },
                    smoothed: {
                        av: { x: [], y: [], z: [] },
                        la: { x: [], y: [], z: [] }
                    }
                }
            };
            
            document.getElementById('imu0Count').textContent = "0";
            document.getElementById('imu1Count').textContent = "0";
            
            messageQueue = [];
            
            // 清空轨迹线
            if (polyline) {
                polyline.setLatLngs([]);
            }
            
            updateAllCharts();
            showNotification('所有数据已清空', 'info');
        }
        
        // 页面加载完成后初始化
        window.onload = function() {
            initCharts();
            initMap();
            initWorker();
            updateConnectionStatus('disconnected');
            showNotification('页面加载完成，请配置MQTT连接', 'info');
            
            // 启动定时轮询处理
            setInterval(() => {
                if (messageQueue.length > 0) {
                    processBatchInWorker();
                }
            }, 500); // 每500ms检查队列
        };
    </script>
</body>
</html>